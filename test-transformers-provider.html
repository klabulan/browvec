<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TransformersProvider - Browser Integration Tests</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }

        h2 {
            color: #34495e;
            margin-top: 30px;
        }

        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border-left: 4px solid #3498db;
            background-color: #f8f9fa;
        }

        .test-case {
            margin: 15px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
        }

        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .status.pending { background-color: #f39c12; color: white; }
        .status.running { background-color: #3498db; color: white; }
        .status.passed { background-color: #27ae60; color: white; }
        .status.failed { background-color: #e74c3c; color: white; }
        .status.warning { background-color: #f39c12; color: white; }

        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .metric {
            background: #ecf0f1;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }

        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
        }

        .metric-label {
            font-size: 0.9em;
            color: #7f8c8d;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .log {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .progress-container {
            background: #f8f9fa;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-bar {
            background: #3498db;
            height: 20px;
            transition: width 0.3s ease;
            color: white;
            text-align: center;
            line-height: 20px;
            font-size: 0.8em;
        }

        .embedding-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            max-height: 150px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.8em;
        }

        .test-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .compatibility-check {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .compatibility-item {
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .supported { background-color: #d4edda; border-color: #c3e6cb; }
        .not-supported { background-color: #f8d7da; border-color: #f5c6cb; }

        @media (max-width: 768px) {
            .metrics {
                grid-template-columns: 1fr 1fr;
            }
            .test-controls {
                flex-direction: column;
            }
            .compatibility-check {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ TransformersProvider - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ</h1>

        <div class="test-section">
            <h2>–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –±—Ä–∞—É–∑–µ—Ä–∞</h2>
            <div id="compatibility-results" class="compatibility-check">
                <div class="compatibility-item">
                    <strong>Web Workers</strong>
                    <div id="worker-support">–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è...</div>
                </div>
                <div class="compatibility-item">
                    <strong>SharedArrayBuffer</strong>
                    <div id="sab-support">–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è...</div>
                </div>
                <div class="compatibility-item">
                    <strong>WebAssembly</strong>
                    <div id="wasm-support">–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è...</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞–º–∏</h2>
            <div class="test-controls">
                <button onclick="runAllTests()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã</button>
                <button onclick="runPerformanceTest()">–¢–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</button>
                <button onclick="runStressTest()">–ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —Ç–µ—Å—Ç</button>
                <button onclick="clearResults()">–û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
                <button onclick="exportResults()">–≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</button>
            </div>
        </div>

        <div class="test-section">
            <h2>–°—Ç–∞—Ç—É—Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
            <div class="progress-container">
                <div id="overall-progress" class="progress-bar" style="width: 0%">0%</div>
            </div>
            <div id="current-test-status">–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é</div>
        </div>

        <div class="test-section">
            <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤</h2>
            <div id="test-results"></div>
        </div>

        <div class="test-section">
            <h2>–ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</h2>
            <div class="metrics" id="performance-metrics">
                <div class="metric">
                    <div class="metric-value" id="model-load-time">-</div>
                    <div class="metric-label">–í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏ (–º—Å)</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="avg-generation-time">-</div>
                    <div class="metric-label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–º—Å)</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="memory-usage">-</div>
                    <div class="metric-label">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ (MB)</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="throughput">-</div>
                    <div class="metric-label">–ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å (—Ç–µ–∫—Å—Ç—ã/—Å–µ–∫)</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="success-rate">-</div>
                    <div class="metric-label">–ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—Ö–∞ (%)</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="cache-hit-rate">-</div>
                    <div class="metric-label">–ü–æ–ø–∞–¥–∞–Ω–∏—è –≤ –∫—ç—à (%)</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>–ü—Ä–∏–º–µ—Ä –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤</h2>
            <div>
                <label for="test-text">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞:</label>
                <br>
                <textarea id="test-text" rows="3" cols="80" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞...">–≠—Ç–æ –ø—Ä–∏–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞ —Å –ø–æ–º–æ—â—å—é all-MiniLM-L6-v2 –º–æ–¥–µ–ª–∏.</textarea>
                <br>
                <button onclick="generateTestEmbedding()" id="generate-btn">–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥</button>
                <button onclick="generateBatchTest()" id="batch-btn">–¢–µ—Å—Ç –±–∞—Ç—á–µ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</button>
            </div>
            <div id="embedding-result"></div>
        </div>

        <div class="test-section">
            <h2>–ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π</h2>
            <div id="test-log" class="log"></div>
        </div>
    </div>

    <script type="module">
        import { TransformersProvider, isTransformersSupported, getModelInfo } from './src/embedding/providers/TransformersProvider.ts';
        import { MemoryCache } from './src/embedding/cache/MemoryCache.ts';

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        let provider = null;
        let cache = null;
        let testResults = [];
        let isTestRunning = false;

        // –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        function log(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('test-log');
            const levelPrefix = level === 'error' ? '‚ùå' : level === 'warning' ? '‚ö†Ô∏è' : level === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            logElement.textContent += `[${timestamp}] ${levelPrefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;

            if (level === 'error') {
                console.error(message);
            } else {
                console.log(message);
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –±—Ä–∞—É–∑–µ—Ä–∞
        function checkBrowserCompatibility() {
            log('–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –±—Ä–∞—É–∑–µ—Ä–∞...');

            const workerSupport = typeof Worker !== 'undefined';
            const sabSupport = typeof SharedArrayBuffer !== 'undefined';
            const wasmSupport = typeof WebAssembly !== 'undefined';

            document.getElementById('worker-support').innerHTML = workerSupport
                ? '<span style="color: green">‚úì –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</span>'
                : '<span style="color: red">‚úó –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</span>';

            document.getElementById('sab-support').innerHTML = sabSupport
                ? '<span style="color: green">‚úì –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</span>'
                : '<span style="color: red">‚úó –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</span>';

            document.getElementById('wasm-support').innerHTML = wasmSupport
                ? '<span style="color: green">‚úì –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</span>'
                : '<span style="color: red">‚úó –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</span>';

            const compatibilityItems = document.querySelectorAll('.compatibility-item');
            compatibilityItems[0].className = `compatibility-item ${workerSupport ? 'supported' : 'not-supported'}`;
            compatibilityItems[1].className = `compatibility-item ${sabSupport ? 'supported' : 'not-supported'}`;
            compatibilityItems[2].className = `compatibility-item ${wasmSupport ? 'supported' : 'not-supported'}`;

            const overallSupported = workerSupport && sabSupport && wasmSupport;
            log(`–û–±—â–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: ${overallSupported ? '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è' : '–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞'}`,
                overallSupported ? 'success' : 'warning');

            return overallSupported;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ç–µ—Å—Ç–∞
        function updateTestStatus(message) {
            document.getElementById('current-test-status').textContent = message;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        function updateProgress(completed, total) {
            const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
            const progressBar = document.getElementById('overall-progress');
            progressBar.style.width = `${percent}%`;
            progressBar.textContent = `${percent}%`;
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ç–µ—Å—Ç–∞
        function addTestResult(name, status, details, duration) {
            const testResult = { name, status, details, duration, timestamp: new Date() };
            testResults.push(testResult);

            const resultsContainer = document.getElementById('test-results');
            const testDiv = document.createElement('div');
            testDiv.className = 'test-case';

            testDiv.innerHTML = `
                <strong>${name}</strong>
                <span class="status ${status}">${status.toUpperCase()}</span>
                <div style="margin-top: 10px;">
                    <small>–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${duration}–º—Å</small>
                    <br>
                    ${details}
                </div>
            `;

            resultsContainer.appendChild(testDiv);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
        async function initializeProvider() {
            try {
                if (provider) {
                    try {
                        await provider.cleanup();
                    } catch (cleanupError) {
                        log(`–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ: ${cleanupError.message}`, 'warning');
                    }
                }

                provider = new TransformersProvider({
                    enableLogging: true,
                    modelLoadTimeout: 60000, // 1 –º–∏–Ω—É—Ç–∞ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É –º–æ–¥–µ–ª–∏
                    operationTimeout: 30000,  // 30 —Å–µ–∫—É–Ω–¥ –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—é
                    batchSize: 8,
                    // –î–æ–±–∞–≤–ª—è–µ–º –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    workerScript: '/src/embedding/workers/transformers-worker.js'
                });

                cache = new MemoryCache({
                    maxEntries: 1000,
                    maxSizeBytes: 50 * 1024 * 1024, // 50MB
                    enableLogging: true
                });

                log('–ù–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞...', 'info');
                const startTime = Date.now();

                try {
                    await provider.initialize({ provider: 'transformers', dimensions: 384 });
                    const loadTime = Date.now() - startTime;

                    document.getElementById('model-load-time').textContent = loadTime;
                    log(`–ü—Ä–æ–≤–∞–π–¥–µ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∑–∞ ${loadTime}–º—Å`, 'success');
                    return true;
                } catch (initError) {
                    log(`–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${initError.message}`, 'error');
                    if (initError.stack) {
                        log(`Stack trace: ${initError.stack}`, 'error');
                    }
                    throw initError;
                }

            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞: ${error.message}`, 'error');
                log(`–¢–∏–ø –æ—à–∏–±–∫–∏: ${error.constructor.name}`, 'error');

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–≤—è–∑–∞–Ω–∞ –ª–∏ –æ—à–∏–±–∫–∞ —Å –≤–æ—Ä–∫–µ—Ä–æ–º
                if (error.message.includes('Worker') || error.message.includes('worker')) {
                    log('–≠—Ç–æ –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∞–Ω–Ω–∞—è —Å Web Worker. –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:', 'warning');
                    log('1. –§–∞–π–ª –≤–æ—Ä–∫–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'warning');
                    log('2. –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –≤ –≤–æ—Ä–∫–µ—Ä–µ', 'warning');
                    log('3. –ü—Ä–æ–±–ª–µ–º—ã —Å CORS –∏–ª–∏ –º–æ–¥—É–ª—è–º–∏ ES6', 'warning');
                }

                return false;
            }
        }

        // –¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–¥–Ω–æ–≥–æ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞
        async function testSingleEmbedding() {
            const startTime = Date.now();

            try {
                updateTestStatus('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–¥–Ω–æ–≥–æ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞...');

                const testText = '–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞.';
                const embedding = await provider.generateEmbedding(testText);

                const duration = Date.now() - startTime;

                if (embedding instanceof Float32Array && embedding.length === 384) {
                    addTestResult('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–¥–Ω–æ–≥–æ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞', 'passed',
                        `–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —ç–º–±–µ–¥–¥–∏–Ω–≥ —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç–∏ ${embedding.length}. –ü–µ—Ä–≤—ã–µ 5 –∑–Ω–∞—á–µ–Ω–∏–π: [${Array.from(embedding.slice(0, 5)).map(v => v.toFixed(4)).join(', ')}]`,
                        duration);
                    return true;
                } else {
                    throw new Error(`–ù–µ–≤–µ—Ä–Ω–∞—è —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–∞: ${embedding.length}`);
                }

            } catch (error) {
                const duration = Date.now() - startTime;
                addTestResult('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–¥–Ω–æ–≥–æ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞', 'failed', error.message, duration);
                log(`–¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–¥–Ω–æ–≥–æ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞ –ø—Ä–æ–≤–∞–ª–µ–Ω: ${error.message}`, 'error');
                return false;
            }
        }

        // –¢–µ—Å—Ç –±–∞—Ç—á–µ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        async function testBatchGeneration() {
            const startTime = Date.now();

            try {
                updateTestStatus('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞—Ç—á–µ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏...');

                const testTexts = [
                    '–ü–µ—Ä–≤—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –±–∞—Ç—á–µ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.',
                    '–í—Ç–æ—Ä–æ–π —Ç–µ–∫—Å—Ç –≤ –±–∞—Ç—á–µ.',
                    '–¢—Ä–µ—Ç–∏–π —Ç–µ–∫—Å—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.',
                    '–ß–µ—Ç–≤–µ—Ä—Ç—ã–π —Ç–µ–∫—Å—Ç –≤ –Ω–∞–±–æ—Ä–µ.',
                    '–ü—è—Ç—ã–π –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ–∫—Å—Ç.'
                ];

                const embeddings = await provider.generateBatch(testTexts);
                const duration = Date.now() - startTime;

                if (embeddings.length === testTexts.length &&
                    embeddings.every(emb => emb instanceof Float32Array && emb.length === 384)) {

                    const avgTime = duration / testTexts.length;
                    addTestResult('–ë–∞—Ç—á–µ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤', 'passed',
                        `–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ ${embeddings.length} —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤. –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –Ω–∞ —ç–º–±–µ–¥–¥–∏–Ω–≥: ${avgTime.toFixed(2)}–º—Å`,
                        duration);
                    return true;
                } else {
                    throw new Error(`–ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–ª–∏ —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤`);
                }

            } catch (error) {
                const duration = Date.now() - startTime;
                addTestResult('–ë–∞—Ç—á–µ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤', 'failed', error.message, duration);
                log(`–¢–µ—Å—Ç –±–∞—Ç—á–µ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–≤–∞–ª–µ–Ω: ${error.message}`, 'error');
                return false;
            }
        }

        // –¢–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        async function testPerformance() {
            const startTime = Date.now();

            try {
                updateTestStatus('–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏...');

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ (8)
                const testTexts = Array.from({ length: 8 }, (_, i) =>
                    `–¢–µ—Å—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –Ω–æ–º–µ—Ä ${i + 1} –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤.`
                );

                const embeddings = await provider.generateBatch(testTexts);
                const duration = Date.now() - startTime;

                const avgTime = duration / testTexts.length;
                const throughput = (testTexts.length / duration) * 1000; // —Ç–µ–∫—Å—Ç—ã –≤ —Å–µ–∫—É–Ω–¥—É

                document.getElementById('avg-generation-time').textContent = Math.round(avgTime);
                document.getElementById('throughput').textContent = throughput.toFixed(2);

                addTestResult('–¢–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏', 'passed',
                    `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${testTexts.length} —Ç–µ–∫—Å—Ç–æ–≤ –∑–∞ ${duration}–º—Å. –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å: ${throughput.toFixed(2)} —Ç–µ–∫—Å—Ç—ã/—Å–µ–∫`,
                    duration);

                return true;

            } catch (error) {
                const duration = Date.now() - startTime;
                addTestResult('–¢–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏', 'failed', error.message, duration);
                return false;
            }
        }

        // –¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è
        async function testHealthCheck() {
            const startTime = Date.now();

            try {
                updateTestStatus('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞...');

                const health = await provider.healthCheck();
                const duration = Date.now() - startTime;

                if (health.isHealthy) {
                    addTestResult('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è', 'passed',
                        `–°—Ç–∞—Ç—É—Å: ${health.status}. ${health.details}`, duration);
                    return true;
                } else {
                    addTestResult('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è', 'warning',
                        `–°—Ç–∞—Ç—É—Å: ${health.status}. ${health.details}`, duration);
                    return false;
                }

            } catch (error) {
                const duration = Date.now() - startTime;
                addTestResult('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è', 'failed', error.message, duration);
                return false;
            }
        }

        // –¢–µ—Å—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
        async function testCaching() {
            if (!cache) return false;

            const startTime = Date.now();

            try {
                updateTestStatus('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è...');

                const testText = '–¢–µ—Å—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —ç–º–±–µ–¥–¥–∏–Ω–≥–∞.';
                const config = { provider: 'transformers', dimensions: 384 };

                // –ü–µ—Ä–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è - –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–ø–∏—Å–∞–Ω–∞ –≤ –∫—ç—à
                const embedding1 = await provider.generateEmbedding(testText);
                await cache.set(testText, embedding1, config);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤ –∫—ç—à–µ
                const cachedEmbedding = await cache.get(testText, config);
                const isInCache = await cache.has(testText, config);

                const duration = Date.now() - startTime;

                if (isInCache && cachedEmbedding) {
                    const metrics = cache.getMetrics();
                    document.getElementById('cache-hit-rate').textContent =
                        (metrics.hitRate * 100).toFixed(1);

                    addTestResult('–¢–µ—Å—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è', 'passed',
                        `–≠–º–±–µ–¥–¥–∏–Ω–≥ —É—Å–ø–µ—à–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω –∏ –∏–∑–≤–ª–µ—á–µ–Ω. Hit rate: ${(metrics.hitRate * 100).toFixed(1)}%`,
                        duration);
                    return true;
                } else {
                    throw new Error('–≠–º–±–µ–¥–¥–∏–Ω–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫—ç—à–µ');
                }

            } catch (error) {
                const duration = Date.now() - startTime;
                addTestResult('–¢–µ—Å—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è', 'failed', error.message, duration);
                return false;
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
        function updateMetrics() {
            try {
                if (!provider) return;

                const metrics = provider.getMetrics();
                const transformersMetrics = provider.getTransformersMetrics();

                document.getElementById('avg-generation-time').textContent =
                    Math.round(metrics.averageResponseTime) || '-';

                document.getElementById('memory-usage').textContent =
                    transformersMetrics.memoryPeak ?
                    (transformersMetrics.memoryPeak / (1024 * 1024)).toFixed(1) : '-';

                document.getElementById('success-rate').textContent =
                    metrics.totalRequests > 0 ?
                    ((metrics.successfulRequests / metrics.totalRequests) * 100).toFixed(1) : '-';

                if (cache) {
                    const cacheMetrics = cache.getMetrics();
                    document.getElementById('cache-hit-rate').textContent =
                        (cacheMetrics.hitRate * 100).toFixed(1);
                }

            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫: ${error.message}`, 'error');
            }
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
        window.runAllTests = async function() {
            if (isTestRunning) {
                log('–¢–µ—Å—Ç—ã —É–∂–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è!', 'warning');
                return;
            }

            isTestRunning = true;
            testResults = [];
            document.getElementById('test-results').innerHTML = '';

            log('–ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ –Ω–∞–±–æ—Ä–∞ —Ç–µ—Å—Ç–æ–≤...', 'info');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
            if (!checkBrowserCompatibility()) {
                addTestResult('–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –±—Ä–∞—É–∑–µ—Ä–∞', 'failed', '–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏', 0);
                isTestRunning = false;
                return;
            }

            const tests = [
                { name: '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞', func: initializeProvider },
                { name: '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–¥–Ω–æ–≥–æ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞', func: testSingleEmbedding },
                { name: '–ë–∞—Ç—á–µ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è', func: testBatchGeneration },
                { name: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è', func: testHealthCheck },
                { name: '–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ', func: testCaching },
                { name: '–¢–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏', func: testPerformance }
            ];

            let passed = 0;

            for (let i = 0; i < tests.length; i++) {
                const test = tests[i];
                updateProgress(i, tests.length);
                updateTestStatus(`–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è: ${test.name}`);

                try {
                    const result = await test.func();
                    if (result) passed++;
                } catch (error) {
                    log(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ —Ç–µ—Å—Ç–µ "${test.name}": ${error.message}`, 'error');
                }

                updateMetrics();

                // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            updateProgress(tests.length, tests.length);
            updateTestStatus(`–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: ${passed}/${tests.length} —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ`);

            const successRate = (passed / tests.length) * 100;
            log(`–í—Å–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã! –£—Å–ø–µ—à–Ω–æ: ${passed}/${tests.length} (${successRate.toFixed(1)}%)`,
                successRate === 100 ? 'success' : successRate >= 80 ? 'warning' : 'error');

            isTestRunning = false;
        };

        // –¢–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        window.runPerformanceTest = async function() {
            if (!provider || isTestRunning) {
                log('–ü—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ –≥–æ—Ç–æ–≤ –∏–ª–∏ —Ç–µ—Å—Ç—ã —É–∂–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è', 'warning');
                return;
            }

            isTestRunning = true;
            updateTestStatus('–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ç–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏...');

            try {
                await testPerformance();
                updateMetrics();
            } finally {
                isTestRunning = false;
                updateTestStatus('–¢–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω');
            }
        };

        // –ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —Ç–µ—Å—Ç
        window.runStressTest = async function() {
            if (!provider || isTestRunning) {
                log('–ü—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ –≥–æ—Ç–æ–≤ –∏–ª–∏ —Ç–µ—Å—Ç—ã —É–∂–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è', 'warning');
                return;
            }

            isTestRunning = true;
            updateTestStatus('–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —Ç–µ—Å—Ç...');

            try {
                const startTime = Date.now();
                // –î–ª—è –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –±–∞—Ç—á–µ–π –ø–æ 8 —Ç–µ–∫—Å—Ç–æ–≤
                const stressTexts = Array.from({ length: 16 }, (_, i) =>
                    `–ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —Ç–µ—Å—Ç - —Ç–µ–∫—Å—Ç –Ω–æ–º–µ—Ä ${i + 1}. –≠—Ç–æ—Ç —Ç–µ–∫—Å—Ç —Å–æ–∑–¥–∞–Ω –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã –ø—Ä–∏ –±–æ–ª—å—à–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ.`
                );

                const embeddings = await provider.generateBatch(stressTexts);
                const duration = Date.now() - startTime;

                addTestResult('–ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —Ç–µ—Å—Ç', 'passed',
                    `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${embeddings.length} —Ç–µ–∫—Å—Ç–æ–≤ –∑–∞ ${duration}–º—Å. –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è: ${(duration/embeddings.length).toFixed(2)}–º—Å –Ω–∞ —Ç–µ–∫—Å—Ç`,
                    duration);

                updateMetrics();
                log(`–ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —Ç–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ`, 'success');

            } catch (error) {
                addTestResult('–ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —Ç–µ—Å—Ç', 'failed', error.message, 0);
                log(`–ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —Ç–µ—Å—Ç –ø—Ä–æ–≤–∞–ª–µ–Ω: ${error.message}`, 'error');
            } finally {
                isTestRunning = false;
                updateTestStatus('–ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —Ç–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω');
            }
        };

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞
        window.generateTestEmbedding = async function() {
            const textArea = document.getElementById('test-text');
            const text = textArea.value.trim();

            if (!text) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞!');
                return;
            }

            if (!provider) {
                alert('–ü—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω! –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã —Å–Ω–∞—á–∞–ª–∞.');
                return;
            }

            const button = document.getElementById('generate-btn');
            button.disabled = true;
            button.textContent = '–ì–µ–Ω–µ—Ä–∏—Ä—É—é...';

            try {
                const startTime = Date.now();
                const embedding = await provider.generateEmbedding(text);
                const duration = Date.now() - startTime;

                const resultDiv = document.getElementById('embedding-result');
                resultDiv.innerHTML = `
                    <div class="success">
                        <strong>–≠–º–±–µ–¥–¥–∏–Ω–≥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ!</strong><br>
                        –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å: ${embedding.length}<br>
                        –í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ${duration}–º—Å<br>
                        –î–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞: ${text.length} —Å–∏–º–≤–æ–ª–æ–≤
                    </div>
                    <div class="embedding-display">
                        ${Array.from(embedding).map((val, idx) => `[${idx}]: ${val.toFixed(6)}`).join('\n')}
                    </div>
                `;

                log(`–≠–º–±–µ–¥–¥–∏–Ω–≥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∑–∞ ${duration}–º—Å –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –¥–ª–∏–Ω–æ–π ${text.length} —Å–∏–º–≤–æ–ª–æ–≤`, 'success');

            } catch (error) {
                document.getElementById('embedding-result').innerHTML = `
                    <div class="error">
                        <strong>–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞:</strong><br>
                        ${error.message}
                    </div>
                `;
                log(`–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = '–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥';
            }
        };

        // –¢–µ—Å—Ç –±–∞—Ç—á–µ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        window.generateBatchTest = async function() {
            if (!provider) {
                alert('–ü—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω! –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã —Å–Ω–∞—á–∞–ª–∞.');
                return;
            }

            const button = document.getElementById('batch-btn');
            button.disabled = true;
            button.textContent = '–ì–µ–Ω–µ—Ä–∏—Ä—É—é –±–∞—Ç—á...';

            try {
                const batchTexts = [
                    '–ü–µ—Ä–≤—ã–π —Ç–µ–∫—Å—Ç –≤ –±–∞—Ç—á–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.',
                    '–í—Ç–æ—Ä–æ–π —Ç–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞—Ç—á–µ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏.',
                    '–¢—Ä–µ—Ç–∏–π —Ç–µ–∫—Å—Ç –≤ –Ω–∞–±–æ—Ä–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö.',
                    '–ß–µ—Ç–≤–µ—Ä—Ç—ã–π –ø—Ä–∏–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤.',
                    '–ü—è—Ç—ã–π –∏ –∑–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –±–∞—Ç—á–∞.'
                ];

                const startTime = Date.now();
                const embeddings = await provider.generateBatch(batchTexts);
                const duration = Date.now() - startTime;

                const resultDiv = document.getElementById('embedding-result');
                resultDiv.innerHTML = `
                    <div class="success">
                        <strong>–ë–∞—Ç—á —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ!</strong><br>
                        –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ–∫—Å—Ç–æ–≤: ${batchTexts.length}<br>
                        –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤: ${embeddings.length}<br>
                        –û–±—â–µ–µ –≤—Ä–µ–º—è: ${duration}–º—Å<br>
                        –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –Ω–∞ —ç–º–±–µ–¥–¥–∏–Ω–≥: ${(duration/embeddings.length).toFixed(2)}–º—Å
                    </div>
                    <div class="embedding-display">
                        –≠–º–±–µ–¥–¥–∏–Ω–≥–∏ —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã. –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –∫–∞–∂–¥–æ–≥–æ: ${embeddings[0].length}
                        <br><br>
                        –ü—Ä–∏–º–µ—Ä –ø–µ—Ä–≤–æ–≥–æ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞:
                        <br>
                        ${Array.from(embeddings[0].slice(0, 10)).map((val, idx) => `[${idx}]: ${val.toFixed(6)}`).join('\n')}
                        <br>... (–ø–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ 10 –∏–∑ ${embeddings[0].length} –∑–Ω–∞—á–µ–Ω–∏–π)
                    </div>
                `;

                log(`–ë–∞—Ç—á –∏–∑ ${embeddings.length} —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∑–∞ ${duration}–º—Å`, 'success');

            } catch (error) {
                document.getElementById('embedding-result').innerHTML = `
                    <div class="error">
                        <strong>–û—à–∏–±–∫–∞ –±–∞—Ç—á–µ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:</strong><br>
                        ${error.message}
                    </div>
                `;
                log(`–û—à–∏–±–∫–∞ –±–∞—Ç—á–µ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = '–¢–µ—Å—Ç –±–∞—Ç—á–µ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏';
            }
        };

        // –û—á–∏—Å—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        window.clearResults = function() {
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('test-log').textContent = '';
            document.getElementById('embedding-result').innerHTML = '';
            testResults = [];
            updateProgress(0, 1);
            updateTestStatus('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—á–∏—â–µ–Ω—ã');

            // –°–±—Ä–æ—Å –º–µ—Ç—Ä–∏–∫
            const metricValues = ['model-load-time', 'avg-generation-time', 'memory-usage', 'throughput', 'success-rate', 'cache-hit-rate'];
            metricValues.forEach(id => {
                document.getElementById(id).textContent = '-';
            });

            log('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤ –æ—á–∏—â–µ–Ω—ã', 'info');
        };

        // –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        window.exportResults = function() {
            const report = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                browserCompatibility: checkBrowserCompatibility(),
                testResults: testResults,
                modelInfo: getModelInfo(),
                transformersSupported: isTransformersSupported()
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `transformers-provider-test-report-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            log('–û—Ç—á–µ—Ç –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', 'success');
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'info');
            checkBrowserCompatibility();

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–¥–µ–ª–∏
            const modelInfo = getModelInfo();
            log(`–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–æ–¥–µ–ª–∏: ${modelInfo.name} (${modelInfo.dimensions}D, ~${(modelInfo.modelSize/(1024*1024)).toFixed(1)}MB)`, 'info');
        });

    </script>
</body>
</html>