# Architecture - LocalRetrieve Integration Fixes (REVISED)

**Date**: 2025-10-02
**Status**: Design Phase - Revised for npm package reality

---

## Executive Summary

After analyzing the actual npm package structure and file distribution, this document presents:

1. **Current Reality**: What files exist where and why
2. **Integration Issues**: Root causes of the problems
3. **Two-Track Solution**:
   - **Track A**: Fix R7 Copilot integration (immediate, 1-2 days)
   - **Track B**: Improve LocalRetrieve package (recommended, submit to upstream)

---

## Current File Distribution Reality

### What We Get from `npm install https://github.com/klabulan/browvec.git`

**Location**: `copilot/node_modules/localretrieve/`

```
node_modules/localretrieve/
├── dist/
│   ├── localretrieve.mjs          ✅ Main SDK entry point
│   ├── sqlite3.mjs                ✅ SQLite WASM loader
│   ├── ProviderFactory-*.mjs      ✅ Provider implementations
│   ├── CacheManager-*.mjs         ✅ Cache management
│   ├── rpc-*.mjs                  ✅ RPC communication
│   ├── database/
│   │   └── worker.js              ✅ Worker implementation
│   └── *.map                      ✅ Source maps
├── package.json                   ✅
└── README.md                      ✅

MISSING FILES:
├── dist/
    ├── sqlite3.wasm               ❌ CRITICAL - SQLite WASM binary
    └── vec0.wasm                  ❌ CRITICAL - sqlite-vec extension
```

**Root Cause**: WASM files are **build artifacts** generated by `npm run build:wasm` but **not committed to git** and thus **not included when installing from GitHub**.

---

### What Was Manually Copied to `copilot/lib/localretrieve/`

**Location**: `copilot/lib/localretrieve/`

```
lib/localretrieve/
├── localretrieve.mjs              ✅ Copied from browvec/dist/
├── sqlite3.mjs                    ✅ Copied from browvec/dist/
├── ProviderFactory-*.mjs          ✅ Copied from browvec/dist/
├── CacheManager-*.mjs             ✅ Copied from browvec/dist/
├── rpc-*.mjs                      ✅ Copied from browvec/dist/
├── database/
│   └── worker.js                  ✅ Copied from browvec/dist/database/
└── *.map                          ✅ Source maps

SHOULD ALSO HAVE (from browvec/dist/):
├── sqlite3.wasm                   ⚠️ EXISTS in browvec/dist/ but NOT copied here
└── vec0.wasm                      ⚠️ May exist in browvec/dist/ but NOT copied here
```

**Status**: Manual copy was correct approach, but **incomplete** - missing WASM files.

---

### What's Actually in browvec Source

**Location**: `D:\localcopilot\browvec\dist\`

```bash
$ ls D:\localcopilot\browvec\dist\
CacheManager-BAFvz7pV.mjs
localretrieve.mjs
ProviderFactory-*.mjs (multiple files)
rpc-*.mjs (multiple files)
sqlite3.mjs
sqlite3.wasm                       ✅ THIS EXISTS!
database/worker.js
*.map
```

**Finding**: `sqlite3.wasm` **DOES EXIST** in the browvec source dist folder. It was built and is ready to use.

---

## Root Cause Analysis

### Issue 1: Why WASM Files Missing from npm Install

**Cause**: GitHub-based npm install (`npm install https://github.com/klabulan/browvec.git`) only includes files committed to git repository.

**Reality Check**:
```bash
# What happens with npm install from GitHub:
1. Git clones the repository
2. Runs `npm install` (dependencies only, NOT build scripts)
3. Copies files listed in package.json "files": ["dist", ...]
4. BUT: dist/ in git doesn't include WASM (they're .gitignored build artifacts)
```

**Proof**:
- `browvec/.gitignore` likely excludes `*.wasm` files
- `browvec/dist/sqlite3.wasm` exists locally after build but is NOT in git
- npm package published to registry would include them, but GitHub install doesn't

---

### Issue 2: Why Manual Copy Approach is Correct

**Why `lib/localretrieve/` exists**:
1. ✅ R7-Office plugin cannot use `node_modules/` directly (not web-accessible)
2. ✅ Plugin needs static files served via HTTP
3. ✅ Service worker needs predictable paths
4. ✅ Manual copy gives control over what's deployed

**What was wrong**:
- ❌ Copied from browvec source but forgot WASM files
- ❌ No documentation of copy procedure
- ❌ No validation that all required files present

---

## Proposed Architecture

### Option A: Fix Current Setup (Recommended for Immediate Solution)

**Principle**: Use `lib/localretrieve/` as deployment directory, source files from local browvec build.

```
Development Workflow:
┌─────────────────────────────────────────────────────────┐
│ 1. LocalRetrieve Source (D:\localcopilot\browvec\)      │
│    - Developer builds: npm run build                    │
│    - Generates: dist/*.mjs, dist/sqlite3.wasm, etc.     │
└────────────────────────┬────────────────────────────────┘
                         │
                         │ Manual Copy (documented script)
                         ▼
┌─────────────────────────────────────────────────────────┐
│ 2. R7 Copilot Deployment (copilot/lib/localretrieve/)   │
│    ├── localretrieve.mjs                                │
│    ├── sqlite3.mjs                                      │
│    ├── sqlite3.wasm          ← ADDED                    │
│    ├── vec0.wasm (if needed) ← ADDED                    │
│    ├── ProviderFactory-*.mjs                            │
│    ├── CacheManager-*.mjs                               │
│    ├── rpc-*.mjs                                        │
│    └── database/worker.js                               │
└────────────────────────┬────────────────────────────────┘
                         │
                         │ HTTP Server (file://)
                         ▼
┌─────────────────────────────────────────────────────────┐
│ 3. Browser Runtime                                       │
│    ├── plugin.js loads ./lib/localretrieve/localretrieve.mjs│
│    ├── Service worker redirects /sqlite3.mjs → ./lib/...│
│    ├── Worker loads sqlite3.wasm via fetch              │
│    └── SQLite initializes with WASM                     │
└─────────────────────────────────────────────────────────┘
```

**Implementation**:

1. **Create Copy Script**: `copilot/scripts/sync-localretrieve.sh`

```bash
#!/bin/bash
# Sync LocalRetrieve files from source to deployment

SOURCE="../../../browvec/dist"
DEST="./lib/localretrieve"

echo "Syncing LocalRetrieve from $SOURCE to $DEST..."

# Validate source exists
if [ ! -d "$SOURCE" ]; then
    echo "Error: Source directory not found: $SOURCE"
    echo "Run 'cd browvec && npm run build' first"
    exit 1
fi

# Create destination
mkdir -p "$DEST"
mkdir -p "$DEST/database"

# Copy all files
echo "Copying SDK files..."
cp "$SOURCE"/*.mjs "$DEST/"
cp "$SOURCE"/*.map "$DEST/" 2>/dev/null || true

echo "Copying WASM files..."
cp "$SOURCE"/sqlite3.wasm "$DEST/"
cp "$SOURCE"/vec0.wasm "$DEST/" 2>/dev/null || true

echo "Copying worker..."
cp "$SOURCE/database/worker.js" "$DEST/database/"
cp "$SOURCE/database/worker.js.map" "$DEST/database/" 2>/dev/null || true

# Validate WASM files exist
if [ ! -f "$DEST/sqlite3.wasm" ]; then
    echo "ERROR: sqlite3.wasm not found in source!"
    echo "This file is critical and must be present."
    exit 1
fi

echo "✓ LocalRetrieve sync complete"
echo "Files synced:"
ls -lh "$DEST"/*.{mjs,wasm} 2>/dev/null || true
```

2. **Add to package.json**:

```json
{
  "scripts": {
    "sync:localretrieve": "bash scripts/sync-localretrieve.sh",
    "prepackage": "npm run sync:localretrieve"
  }
}
```

3. **Document in README**:

```markdown
## LocalRetrieve Setup

LocalRetrieve files are deployed to `lib/localretrieve/` from the browvec source.

### Initial Setup:
1. Build LocalRetrieve:
   ```bash
   cd ../../../browvec
   npm install
   npm run build
   ```

2. Sync files to plugin:
   ```bash
   cd copilot
   npm run sync:localretrieve
   ```

### Verify Installation:
```bash
ls -lh lib/localretrieve/sqlite3.wasm
# Should show ~2MB file
```
```

**Pros**:
- ✅ Works with current LocalRetrieve (no changes needed upstream)
- ✅ Developer has control over deployed files
- ✅ Can test local browvec changes immediately
- ✅ No npm package publishing required
- ✅ Service worker paths remain simple

**Cons**:
- ❌ Manual sync step required
- ❌ Risk of forgetting to sync before deployment
- ❌ Duplicates files (browvec/dist + copilot/lib)

---

### Option B: Improve LocalRetrieve Package (Recommended to Submit Upstream)

**Principle**: Make LocalRetrieve npm package complete and self-contained.

**Problem to Solve**: WASM files not included when installing from GitHub.

**Recommended Changes to browvec Repository**:

#### Change 1: Commit Built WASM to Git

**File**: `browvec/.gitignore`

```diff
# Build outputs
dist/**/*.js.map
-dist/**/*.wasm
+# Keep WASM files - they're essential for npm installs
+# dist/**/*.wasm

dist/**/*.d.ts
```

**Rationale**:
- WASM files are **stable binary artifacts**, not frequently changing code
- They're essential for package functionality
- Size is reasonable (~2MB for sqlite3.wasm)
- Similar packages (e.g., sql.js) commit WASM to git

**Alternative**: Use Git LFS for WASM files if size is concern

---

#### Change 2: Add postinstall Script

**File**: `browvec/package.json`

```json
{
  "scripts": {
    "postinstall": "node scripts/verify-install.js"
  }
}
```

**File**: `browvec/scripts/verify-install.js` (NEW)

```javascript
const fs = require('fs');
const path = require('path');

const requiredFiles = [
    'dist/localretrieve.mjs',
    'dist/sqlite3.mjs',
    'dist/sqlite3.wasm',
    'dist/database/worker.js'
];

console.log('Verifying LocalRetrieve installation...');

let missing = [];
for (const file of requiredFiles) {
    const filePath = path.join(__dirname, '..', file);
    if (!fs.existsSync(filePath)) {
        missing.push(file);
    }
}

if (missing.length > 0) {
    console.error('ERROR: LocalRetrieve installation incomplete!');
    console.error('Missing files:');
    missing.forEach(f => console.error(`  - ${f}`));
    console.error('\nPlease run: npm run build');
    process.exit(1);
}

console.log('✓ LocalRetrieve installation verified');
```

---

#### Change 3: Improve Package Distribution

**Option 3a: Publish to npm Registry**

```bash
# Maintainer workflow:
cd browvec
npm run build        # Build WASM
npm version patch    # Update version
npm publish          # Publish to npm registry
```

Then users can:
```bash
npm install localretrieve  # Gets complete package with WASM
```

**Option 3b: Include WASM in GitHub Releases**

**File**: `browvec/.github/workflows/release.yml` (NEW)

```yaml
name: Release
on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm install
      - run: npm run build
      - name: Package release
        run: |
          tar -czf localretrieve-${{ github.ref_name }}.tar.gz dist/
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: localretrieve-${{ github.ref_name }}.tar.gz
```

Then users can:
```bash
# Download from releases
curl -L https://github.com/klabulan/browvec/releases/download/v0.1.0/localretrieve-v0.1.0.tar.gz | tar xz
```

---

#### Change 4: Add Bundled Distribution Option

**File**: `browvec/package.json`

```json
{
  "scripts": {
    "bundle": "node scripts/create-bundle.js"
  }
}
```

**File**: `browvec/scripts/create-bundle.js` (NEW)

```javascript
// Creates a single-directory bundle ready for deployment
const fs = require('fs-extra');
const path = require('path');

const BUNDLE_DIR = 'bundle';

async function createBundle() {
    console.log('Creating deployment bundle...');

    // Clean and create bundle directory
    await fs.remove(BUNDLE_DIR);
    await fs.ensureDir(BUNDLE_DIR);

    // Copy all dist files
    await fs.copy('dist', BUNDLE_DIR);

    // Verify WASM files present
    const wasmFiles = ['sqlite3.wasm'];
    for (const file of wasmFiles) {
        const filePath = path.join(BUNDLE_DIR, file);
        if (!fs.existsSync(filePath)) {
            throw new Error(`Missing ${file} - run npm run build:wasm first`);
        }
    }

    // Create README
    const readme = `# LocalRetrieve Bundle

This is a ready-to-deploy bundle of LocalRetrieve.

## Contents:
- localretrieve.mjs - Main SDK
- sqlite3.mjs - SQLite loader
- sqlite3.wasm - SQLite WASM binary
- database/worker.js - Background worker
- ProviderFactory-*.mjs - Provider implementations
- CacheManager-*.mjs - Cache management
- rpc-*.mjs - RPC layer

## Usage:
Copy this entire directory to your web application's static files.

### Example:
\`\`\`bash
cp -r bundle/* /path/to/your/app/lib/localretrieve/
\`\`\`

### Load in your app:
\`\`\`javascript
import { initLocalRetrieve } from './lib/localretrieve/localretrieve.mjs';

const db = await initLocalRetrieve('opfs:/myapp.db', {
    workerUrl: './lib/localretrieve/database/worker.js'
});
\`\`\`
`;

    await fs.writeFile(path.join(BUNDLE_DIR, 'README.md'), readme);

    console.log('✓ Bundle created in bundle/');
    console.log('  Files:', await fs.readdir(BUNDLE_DIR));
}

createBundle().catch(console.error);
```

**Usage**:
```bash
cd browvec
npm run build    # Build WASM
npm run bundle   # Create bundle/

# Then copy to your app
cp -r bundle/* ../r7_copilot/copilot/lib/localretrieve/
```

---

## Recommended Solution: Hybrid Approach

### Immediate (This Week): Option A

1. **Copy WASM files** from `D:\localcopilot\browvec\dist\` to `copilot/lib/localretrieve/`:
   ```bash
   cp D:\localcopilot\browvec\dist\sqlite3.wasm copilot/lib/localretrieve/
   ```

2. **Create sync script** (`copilot/scripts/sync-localretrieve.sh`) as shown above

3. **Document procedure** in `copilot/README.md`

4. **Validate** with startup check in `plugin.js`

**Result**: R7 Copilot works immediately with current LocalRetrieve.

---

### Long-term (Submit to LocalRetrieve): Option B

1. **Fork browvec** repository

2. **Implement improvements**:
   - Commit WASM files to git (or use Git LFS)
   - Add `postinstall` verification script
   - Add `npm run bundle` command
   - Add GitHub Actions for releases

3. **Submit Pull Request** to klabulan/browvec with:
   - **Title**: "Include WASM files in npm package distribution"
   - **Description**: Explain the problem and solution
   - **Benefits**:
     - Users can `npm install` and have working package
     - No manual build steps required
     - Better developer experience
     - Follows npm package best practices

4. **If accepted**: Update R7 Copilot to use:
   ```bash
   npm install localretrieve@latest
   npm run sync:localretrieve  # Still needed for web deployment
   ```

**Result**: LocalRetrieve becomes more robust and easier to use for all consumers.

---

## Updated R7 Copilot Architecture

### File Structure (After Fix)

```
copilot/
├── package.json
├── scripts/
│   └── sync-localretrieve.sh      ← NEW: Automated sync
├── lib/
│   └── localretrieve/              ← Deployment directory
│       ├── localretrieve.mjs       ✅ From browvec/dist
│       ├── sqlite3.mjs             ✅ From browvec/dist
│       ├── sqlite3.wasm            ✅ ADDED from browvec/dist
│       ├── vec0.wasm               ✅ ADDED (if exists)
│       ├── ProviderFactory-*.mjs   ✅ From browvec/dist
│       ├── CacheManager-*.mjs      ✅ From browvec/dist
│       ├── rpc-*.mjs               ✅ From browvec/dist
│       └── database/
│           └── worker.js           ✅ From browvec/dist
├── scripts/
│   ├── plugin.js                   ✅ No changes to loading logic
│   ├── storage/
│   │   ├── storage-manager.js      ⚠️ Fix API usage (insertDocumentWithEmbedding)
│   │   └── storage-coordinator.js  ⚠️ Consider removing
│   └── ...
├── localretrieve-sw.js             ✅ No changes (already correct)
└── node_modules/
    └── localretrieve/              ← From npm (incomplete, NOT USED for runtime)
        └── dist/                   ❌ Missing WASM, used only for reference
```

---

### Initialization Flow (No Changes Needed)

```
Browser
  │
  ├─► plugin.js
  │     │
  │     ├─► Register Service Worker (localretrieve-sw.js)
  │     │     └─► Intercepts /sqlite3.mjs → ./lib/localretrieve/sqlite3.mjs
  │     │
  │     ├─► import('./lib/localretrieve/localretrieve.mjs')
  │     │     └─► Returns { initLocalRetrieve, Database }
  │     │
  │     └─► window.initLocalRetrieve = ...
  │
  ├─► StorageManager.initialize()
  │     │
  │     └─► window.initLocalRetrieve('opfs:/r7_localretrieve.db', {
  │           workerUrl: './lib/localretrieve/database/worker.js'
  │         })
  │
  └─► Worker Created
        │
        ├─► Load ./lib/localretrieve/sqlite3.mjs (via service worker redirect)
        │     │
        │     └─► Fetch ./lib/localretrieve/sqlite3.wasm ✅ NOW EXISTS!
        │
        └─► Initialize SQLite ✅
```

**Key Point**: The loading logic in `plugin.js` is **already correct**. It uses `./lib/localretrieve/` paths. We just need to ensure WASM files are present there.

---

## Service Worker - No Changes Needed

**File**: `copilot/localretrieve-sw.js`

This is **already correct** and needs **no changes**:

```javascript
const MODULE_REDIRECTS = {
    '/sqlite3.mjs': '/lib/localretrieve/sqlite3.mjs',
    '/sqlite3.wasm': '/lib/localretrieve/sqlite3.wasm',
};
```

**Why it works**:
- Worker hardcodes `/sqlite3.mjs` request
- Service worker intercepts and redirects to `./lib/localretrieve/sqlite3.mjs`
- Worker then requests `/sqlite3.wasm`
- Service worker intercepts and redirects to `./lib/localretrieve/sqlite3.wasm`

**Validation**: Once `lib/localretrieve/sqlite3.wasm` exists, this will work perfectly.

---

## Issues That Remain (API Usage)

While the file distribution is now clear, these integration issues still need fixing:

### Issue 1: Wrong API Usage in storage-manager.js

**Problem**: Uses raw SQL instead of `insertDocumentWithEmbedding()`

**Impact**: No embeddings generated, search broken

**See**: `requirements.md` Issue #2

---

### Issue 2: Multi-Tab Coordination Conflict

**Problem**: StorageCoordinator acquires OPFS locks independently from LocalRetrieve worker

**Impact**: Race conditions, potential corruption

**See**: `requirements.md` Issue #3

---

### Issue 3: No Validation

**Problem**: No checks that WASM files loaded correctly

**Impact**: Silent failures, hard to debug

**See**: `requirements.md` Issue #8

---

## Implementation Checklist

### Phase 1: File Distribution (Day 1, Morning)

- [ ] **Verify browvec build**:
  ```bash
  cd D:\localcopilot\browvec
  npm run build
  ls -lh dist/sqlite3.wasm  # Should show ~2MB file
  ```

- [ ] **Copy WASM files**:
  ```bash
  cp D:\localcopilot\browvec\dist\sqlite3.wasm \
     D:\localcopilot\r7_copilot\copilot\lib\localretrieve/
  ```

- [ ] **Create sync script**:
  - Create `copilot/scripts/sync-localretrieve.sh`
  - Make executable: `chmod +x`
  - Test run: `npm run sync:localretrieve`

- [ ] **Validate installation**:
  ```bash
  ls -lh copilot/lib/localretrieve/sqlite3.wasm
  # Should show file exists with size ~2MB
  ```

---

### Phase 2: API Usage Fixes (Day 1, Afternoon)

- [ ] **Fix storage-manager.js**:
  - Replace `saveDocument()` raw SQL with `insertDocumentWithEmbedding()`
  - Replace `updateDocument()` with upsert pattern
  - Update `_startEmbeddingProcessor()` for per-collection processing

- [ ] **Fix search implementation**:
  - Replace `searchText()` with `searchAdvanced()` for better control

**See**: `implementation.md` for detailed code changes

---

### Phase 3: Coordination & Validation (Day 2)

- [ ] **Resolve multi-tab**:
  - Remove StorageCoordinator (recommended)
  - OR: Modify to not acquire OPFS locks

- [ ] **Add validation**:
  - WASM file existence check in `plugin.js`
  - Schema validation in `_ensureDocumentCollections()`
  - Service worker registration validation

**See**: `implementation.md` for detailed code changes

---

### Phase 4: Upstream Contribution (Optional, Week 2)

- [ ] **Fork browvec** repository

- [ ] **Implement improvements**:
  - [ ] Commit WASM to git (or Git LFS)
  - [ ] Add postinstall verification
  - [ ] Add `npm run bundle` command
  - [ ] Add GitHub Actions for releases

- [ ] **Submit PR** to upstream

- [ ] **If accepted**: Update R7 Copilot to use published package

---

## Decision Matrix

| Approach | Effort | Time to Working | Long-term Maintenance | Upstream Benefit |
|----------|--------|-----------------|----------------------|------------------|
| **A: Manual Copy + Script** | Low | 1 hour | Medium (manual sync) | None |
| **B: Improve LocalRetrieve** | Medium | 1 week | Low (npm install works) | High |
| **Hybrid (Recommended)** | Medium | 1 day immediate + 1 week for upstream | Low | High |

---

## Summary

### What's Actually Wrong

1. ✅ **File loading architecture is CORRECT** - uses `lib/localretrieve/` properly
2. ❌ **WASM files are MISSING** - forgot to copy `sqlite3.wasm` from browvec/dist
3. ❌ **API usage is WRONG** - bypasses LocalRetrieve's high-level methods
4. ⚠️ **Multi-tab has conflicts** - dual locking mechanisms

### What to Fix

**Immediate (This Week)**:
1. Copy `sqlite3.wasm` from browvec/dist to copilot/lib/localretrieve
2. Create sync script for reproducibility
3. Fix API usage in storage-manager.js
4. Resolve multi-tab coordination

**Long-term (Submit to LocalRetrieve)**:
1. Commit WASM files to git
2. Add verification scripts
3. Provide bundle command
4. Publish to npm registry

### What NOT to Change

- ✅ Service worker implementation (perfect as-is)
- ✅ File loading paths (already use lib/localretrieve/)
- ✅ Module loading strategy (ES modules with service worker intercept)

---

**Architecture Status**: Ready for review
**Next**: Implementation plan (`implementation.md`)
